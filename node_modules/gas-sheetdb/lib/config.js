/**
 * WIL.Spreadsheet.config calss
 * Can be used to access '.wilconfig' sheet.
 * @fileoverview includes WIL.Spreadsheet.config calss.
 */

var SpreadsheetApp = require('SpreadsheetApp');
var Table = require('./Table');

var CONFIG_SHEET_NAME = '.config',
    configTables_ = [],
    settingData_ = [];


/**
 * Get settings described in .config sheet.
 * @param {string} nameOfGroup : Group name of settings.
 * @param {string} spreadsheetId
 * @return {Array.<Object>} Array of settings object including properties.
 */
function getSettings(nameOfGroup, spreadsheetId) {

  spreadsheetId = spreadsheetId || '';

  if (settingData_[spreadsheetId]) {
    if (settingData_[spreadsheetId][nameOfGroup]) {
      return settingData_[spreadsheetId][nameOfGroup];
    }
  }

  var /** @type {Object} */ ss, sheet, table;
  if (! configTables_[spreadsheetId]) {
    if (spreadsheetId !== '') {
      ss = SpreadsheetApp.openById(spreadsheetId);
    } else {
      ss = SpreadsheetApp.getActiveSpreadsheet();
    }
    sheet = ss.getSheetByName(CONFIG_SHEET_NAME);
    configTables_[spreadsheetId] = new Table(sheet, 4, 1, -1, 4);
  }
  table = configTables_[spreadsheetId];

  var settings = {}, groupName = '', objectName = '',
      name, i, max = table.getNumRows();

  for (i = 1; i <= max; i++) {
    name = table.getValue(i, 1);
    groupName = (name === '') ? groupName : name;

    if (groupName === nameOfGroup) {
      name = table.getValue(i, 2);
      objectName = (name === '') ? objectName : name;

      name = table.getValue(i, 3);
      if (name !== '') {
        if (! settings[objectName]) {
          settings[objectName] = {};
        }
        settings[objectName][name] = table.getValue(i, 4);
      }
    }
  }

  settingData_[spreadsheetId] = settingData_[spreadsheetId] || {};
  settingData_[spreadsheetId][nameOfGroup] = settings;
  return settings;
}



module.exports = {
  getSettings: getSettings
};
